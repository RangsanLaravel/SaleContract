@model List<SaleContractAPI.DataContract.company_detail>
@{
    ViewData["Title"] = "Home Page";
}
<!-- Button trigger modal -->
<button type="button" id="showedit" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#staticBackdrop" hidden>
    Launch static backdrop modal
</button>

<!-- Button trigger modal -->
<button type="button" id="showtimeline" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#timeline" hidden>
    Launch static backdrop modal
</button>

<!-- Button trigger modal -->
<button type="button" id="showreply" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#reply" hidden>
    Launch static backdrop modal
</button>

<!-- Modal -->
<div class="modal fade bd-example-modal-lg" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="staticBackdropLabel">ปรับสถานะงาน </h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                @if (ViewData["position"] == "CK")
                {
                    <div class="row">
                        <div class="col-4">
                            <label for="edName" class="form-label">Name </label>
                            <input type="text" name="edName" id="edName" class="form-control" />
                        </div>
                        <div class="col-4">
                            <label for="edwebsite" class="form-label">Website </label>
                            <input type="text" name="edwebsite" id="edwebsite" class="form-control" />
                        </div>
                        <div class="col-4">
                            <label for="edContact" class="form-label">Contact </label>
                            <input type="text" name="edContact" id="edContact" class="form-control" />
                        </div>
                    </div>
                    <div class="row">
                        <input id="companyid" hidden />
                        <div class="col-4">
                            <label for="edpriority" class="form-label">Priority </label>
                            <select id="edpriority" class="form-select" aria-label="Default select example">
                                @if (ViewData["priority"] != null)
                                {
                                    var priority = ViewData["priority"] as List<SaleContractAPI.DataContract.Priority>;
                                    for (int i = 0; i < priority.Count; i++)
                                    {
                                        <option value="@priority[i].ID">@priority[i].Priority_description</option>
                                    }
                                }

                            </select>
                        </div>
                        <div class="col-4">
                            <label for="edstatus" class="form-label">Status Company</label>
                            <select id="edstatus" class="form-select" aria-label="Default select example">
                                @if (ViewData["substatus"] != null)
                                {
                                    var substatus = ViewData["substatus"] as List<SaleContractAPI.DataContract.substatus>;
                                    for (int i = 0; i < substatus.Count; i++)
                                    {
                                        <option value="@substatus[i].STATUS_CODE">@substatus[i].STATUS_DESCRIPTION</option>
                                    }
                                }
                            </select>
                        </div>
                        <div class="col-4">
                            <label for="ednoti" class="form-label">Notification </label>
                            <input type="text" id="ednoti" class="form-control" name="ednoti">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-4">
                            <label for="edPosition" class="form-label">Position </label>
                            <input type="text" name="edPosition" id="edPosition" class="form-control" />
                        </div>
                        <div class="col-4">
                            <label for="edEmail" class="form-label">Email </label>
                            <input type="text" name="edEmail" id="edEmail" class="form-control" />
                        </div>
                        <div class="col-4">
                            <label for="edMobile" class="form-label">Mobile </label>
                            <input type="text" name="edMobile" id="edMobile" class="form-control" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-4">
                            <label for="edModelTypes" class="form-label">Model Types </label>
                            <input type="text" name="edModelTypes" id="edModelTypes" class="form-control" />
                        </div>
                        <div class="col-4">
                            <label for="edLocation" class="form-label">Location </label>
                            <input type="text" name="edLocation" id="edLocation" class="form-control" />
                        </div>
                        <div class="col-4">
                            <label for="edPeople" class="form-label">People </label>
                            <input type="text" name="edPeople" id="edPeople" class="form-control" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-4">
                            <label for="edDealcreationdate" class="form-label">Deal creation date</label>
                            <input type="text" id="edDealcreationdate" class="form-control" name="edDealcreationdate" >
                        </div>
                        <div class="col-4">
                            <label for="edDuedatefollowup" class="form-label">Due date follow up </label>
                            <input type="text" id="edDuedatefollowup" class="form-control" name="edDuedatefollowup">
                        </div>
                        <div class="col-4">
                            <label for="edDealvalue" class="form-label">Deal value </label>
                            <input type="number" name="edDealvalue" class="form-control" id="edDealvalue" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-4">
                            <label for="edPersen" class="form-label">Persen</label>
                            <input type="number" id="edPersen" class="form-control" name="edPersen" disabled>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <label for="remark" class="form-label">Remark</label>
                            <textarea class="form-control" id="remark" rows="3"></textarea>
                        </div>
                    </div>                  
                }else
                {
                    <div class="row">
                        <div class="col-4">
                            <label for="edName" class="form-label">Name </label>
                            <input type="text" name="edName" id="edName" class="form-control" disabled />
                        </div>
                        <div class="col-4">
                            <label for="edwebsite" class="form-label">Website </label>
                            <input type="text" name="edwebsite" id="edwebsite" class="form-control" disabled />
                        </div>
                        <div class="col-4">
                            <label for="edContact" class="form-label">Contact </label>
                            <input type="text" name="edContact" id="edContact" class="form-control" />
                        </div>
                    </div>
                    <div class="row">
                        <input id="companyid" hidden />
                        <div class="col-4">
                            <label for="edpriority" class="form-label">Priority </label>
                            <select id="edpriority" class="form-select" aria-label="Default select example">
                                @if (ViewData["priority"] != null)
                                {
                                    var priority = ViewData["priority"] as List<SaleContractAPI.DataContract.Priority>;
                                    for (int i = 0; i < priority.Count; i++)
                                    {
                                        <option value="@priority[i].ID">@priority[i].Priority_description</option>
                                    }
                                }

                            </select>
                        </div>
                        <div class="col-4">
                            <label for="edstatus" class="form-label">Status Company</label>
                            <select id="edstatus" class="form-select" aria-label="Default select example">
                                @if (ViewData["substatus"] != null)
                                {
                                    var substatus = ViewData["substatus"] as List<SaleContractAPI.DataContract.substatus>;
                                    for (int i = 0; i < substatus.Count; i++)
                                    {
                                        <option value="@substatus[i].STATUS_CODE">@substatus[i].STATUS_DESCRIPTION</option>
                                    }
                                }
                            </select>
                        </div>
                        <div class="col-4">
                            <label for="ednoti" class="form-label">Notification </label>
                            <input type="text" id="ednoti" class="form-control" name="ednoti" >
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-4">
                            <label for="edPosition" class="form-label">Position </label>
                            <input type="text" name="edPosition" id="edPosition" class="form-control" disabled />
                        </div>
                        <div class="col-4">
                            <label for="edEmail" class="form-label">Email </label>
                            <input type="text" name="edEmail" id="edEmail" class="form-control" />
                        </div>
                        <div class="col-4">
                            <label for="edMobile" class="form-label">Mobile </label>
                            <input type="text" name="edMobile" id="edMobile" class="form-control"  />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-4">
                            <label for="edModelTypes" class="form-label">Model Types </label>
                            <input type="text" name="edModelTypes" id="edModelTypes" class="form-control" />
                        </div>
                        <div class="col-4">
                            <label for="edLocation" class="form-label">Location </label>
                            <input type="text" name="edLocation" id="edLocation" class="form-control" />
                        </div>
                        <div class="col-4">
                            <label for="edPeople" class="form-label">People </label>
                            <input type="text" name="edPeople" id="edPeople" class="form-control" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-4">
                            <label for="edDealcreationdate" class="form-label">Deal creation date</label>
                            <input type="text" id="edDealcreationdate" class="form-control" name="edDealcreationdate" >
                        </div>
                        <div class="col-4">
                            <label for="edDuedatefollowup" class="form-label">Due date follow up </label>
                            <input type="text" id="edDuedatefollowup" class="form-control" name="edDuedatefollowup">
                        </div>
                        <div class="col-4">
                            <label for="edDealvalue" class="form-label">Deal value </label>
                            <input type="number" name="edDealvalue" class="form-control" id="edDealvalue" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-4">
                            <label for="edPersen" class="form-label">Persen</label>
                            <input type="number" id="edPersen" class="form-control" name="edPersen">
                        </div>                       
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <label for="remark" class="form-label">Remark</label>
                            <textarea class="form-control" id="remark" rows="3"></textarea>
                        </div>
                    </div>
                }
               
            </div>
            <div class="modal-footer">
                <button id="closemodal" type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="updatestatus()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal timeline-->
<div class="modal fade" id="timeline" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h1 id=companyid" class="modal-title fs-5">แสดงสถานะงานย่อย </h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col">
                        <div class="timeline-steps aos-init aos-animate" data-aos="fade-up">
                            <div class="col-md-6 offset-md-3">
                             <h4>Status</h4>
                                <ul id="renderiframe" class="timeline">

                            </ul>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Remark -->
<div class="modal fade" id="reply" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5">Remark </h1>
                <button id="clsreply" type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input id="ID_REMARK_UPLINE" hidden/>
                <div class="row">
                    <div class="col-12">                    
                        <textarea class="form-control" id="remarkreply" rows="3"></textarea>
                    </div>
                </div>
                <div class="row mt-2">
                    <button type="button" class="btn btn-primary" onclick="SaveRemark()">Save</button>
                </div>
            </div>
        </div>
    </div>
</div>

<form id="frmsearch" asp-action="Index" asp-controller="Home" asp-antiforgery="true">
    <div class="row">
        <div class="mb-3">
            <label for="ddpPriority" class="form-label">Priority</label>
            <select id="ddpPriority" name="Priority" class="form-select form-select-sm" aria-label=".form-select-sm example">
                <option value="" selected>- ทั้งหมด -</option>
                @if (ViewData["priority"] != null)
                {
                    var priority = ViewData["priority"] as List<SaleContractAPI.DataContract.Priority>;
                    for (int i = 0; i < priority.Count; i++)
                    {                       
                      <option value="@priority[i].ID">@priority[i].Priority_description</option>                        
                    }
                }
            </select>
        </div>
        <div class="mb-3">
            <label for="ddpStatus" class="form-label">Status</label>
            <select id="ddpStatus" name="status" class="form-select form-select-sm" aria-label=".form-select-sm example">
                <option value="" selected>- ทั้งหมด -</option>
                @if (ViewData["substatus"] != null)
                {
                    var substatus = ViewData["substatus"] as List<SaleContractAPI.DataContract.substatus>;
                    for (int i = 0; i < substatus.Count; i++)
                    {
                        <option value="@substatus[i].STATUS_CODE">@substatus[i].STATUS_DESCRIPTION</option>                        
                    }
                }
            </select>
        </div>
        <div class="mb-3">
            <label for="txtName"  class="form-label">Name</label>
            <input type="text" name="NAME" class="form-control" id="txtName" placeholder="Name">
        </div>
        <div class="mb-3 d-flex justify-content-center">
            <button type="submit" class="btn btn-primary btn-sm m-3">Search</button>
            <button type="button" class="btn btn-danger btn-sm m-3" onclick="clearbtn()">Clear</button>
        </div>
    </div>
</form>


    <div class="row">
        <div class="mb-3">
        <a href="@Url.Action("Create","Home")" class="btn btn-success btn-sm m-3">Create</a>
        </div>
    </div>


<div class="row">
        <table id="datarender" class="table table-striped nowrap" style="width:100%">
            <thead>
                <tr>
                <th>#</th>
                <th scope="col">Order</th>
                <th scope="col">Name</th>
                <th scope="col">Website </th>
                <th scope="col">Contract </th>
                <th scope="col">Position </th>
                <th scope="col">Email </th>
                <th scope="col">Mobile </th>
                <th scope="col">Owner </th>
                <th scope="col">Model Types </th>
                <th scope="col">People </th>
                <th scope="col">Status </th>
                <th scope="col">Priority </th>
                <th scope="col">Deal creation date </th>
                <th scope="col">Due date follow up </th>
                <th scope="col">DealDateNoti</th>
                <th scope="col">Deal value </th>
                <th scope="col">% Persen </th>
                <th scope="col">Won</th>
                <th scope="col">Last Updated</th>
                </tr>
            </thead>
            <tbody>
            @if (Model != null)
            {
                for (int i = 0; i < Model.Count; i++)
                {
                    <tr>
                        <th><a href="#" onclick="showtimeline('@Model[i].ID','@Model[i].NAME')"><i class="bi bi-plus-square-fill" style="font-size:15px"></i></a></th>
                        <th ondblclick="showedit('@i')" scope="row">@(i + 1)</th>
                        <td ondblclick="showedit('@i')">@Model[i].NAME </td>
                        <td ondblclick="showedit('@i')">@Model[i].WEBSITE </td>
                        <td ondblclick="showedit('@i')">@Model[i].Contract </td>
                        <td ondblclick="showedit('@i')">@Model[i].Position </td>
                        <td ondblclick="showedit('@i')">@Model[i].Email </td>
                        <td ondblclick="showedit('@i')">@Model[i].Mobile </td>
                        <td ondblclick="showedit('@i')">@Model[i].Owner </td>
                        <td ondblclick="showedit('@i')">@Model[i].ModelType </td>
                        <td ondblclick="showedit('@i')">@Model[i].People </td>
                        <td ondblclick="showedit('@i')">@Model[i].Status</td>
                        <td ondblclick="showedit('@i')">@Model[i].Priority_description </td>
                        <td ondblclick="showedit('@i')">@Model[i].DealCreate </td>
                        <td ondblclick="showedit('@i')">@Model[i].DealDateFollowup </td>
                        <td ondblclick="showedit('@i')">@Model[i].DealDateNoti </td>
                        <td ondblclick="showedit('@i')">@Model[i].DealValue </td>
                        <td ondblclick="showedit('@i')">@Model[i].Persen </td>
                        <td ondblclick="showedit('@i')">@Model[i].Won</td>
                        <td ondblclick="showedit('@i')">@Model[i].LastUpdate</td>
                    </tr>
                }
            }
            else
            {
                <tr>ไม่พบข้อมูล</tr>
            }
        </tbody>
        </table>
    </div>


@section Scripts{
    <script>
        const companydetail = @Html.Raw(Json.Serialize(Model));
        const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
        const dateLocation ='en-US'
        const dateformat ='$2/$1/$3'
        $(document).ready(function (){
            new DataTable('#datarender', {
                responsive: true
            });
        })
        const position ='@ViewData["position"]'

        const clearbtn =()=>{
            let form = document.getElementById("frmsearch");
            form.reset();
        }

        const showedit = (i) => {
            
            $('#companyid').val(companydetail[i].id)
            $('#staticBackdropLabel').text(`ปรับสถานะ ${companydetail[i].name}`)
            $('#edName').val(companydetail[i].name)
            $('#edwebsite').val(companydetail[i].website)
            $('#edContact').val(companydetail[i].contract)
            $('#edPosition').val(companydetail[i].position)
            $('#edEmail').val(companydetail[i].email)
            $('#edMobile').val(companydetail[i].mobile)
            $('#edModelTypes').val(companydetail[i].modelType)
            $('#edLocation').val(companydetail[i].location)
            $('#edPeople').val(companydetail[i].people)
            $('#edDealvalue').val(companydetail[i].dealValue)
            $('#edPersen').val((companydetail[i].persen * 100) / companydetail[i].dealValue)
            $('#edDealcreationdate').datepicker({
                uiLibrary: 'bootstrap5'
            });
            $('#edDuedatefollowup').datepicker({
                uiLibrary: 'bootstrap5'
            });
            $('#ednoti').datepicker({
                uiLibrary: 'bootstrap5'
            });
            if (companydetail[i].dealCreate) {                          
                $('#edDealcreationdate').val(getdate(companydetail[i].dealCreate))
            }
            if (companydetail[i].dealDateFollowup){             
                $('#edDuedatefollowup').val(getdate(companydetail[i].dealDateFollowup))
            }
            if (companydetail[i].dealDateNoti) {
                $('#ednoti').val(getdate(companydetail[i].dealDateNoti))
            }
        
            $('#showedit').click()
        }

        const showtimeline = (id,name) => {
            $('#companyid').text(`สถานะบริษัท:${name}`)
            $('#renderiframe').html('')
            $.ajax({
                url: `@Url.Action("GET_TIMELINE","Home")?companyid=${id}`,
                type: 'GET',
                dataType: 'json',
                success: function (response) {
                    console.log(response)
                    if (response.success) {
                        if (response.data) {
                            let render = ''
                            
                            console.log(response.data)
                            for (let i = 0; i < response.data.length; i++) {
                                let rederreply = ''
                                let tmpchkdup = '';
                                let mrg = 50;
                                if (response.data[i].remark_Statuses) {
                                    console.log(response.data[i].remark_Statuses)
                                     for(let j = 0; j < response.data[i].remark_Statuses.length; j++) {
                                         rederreply += `<div style="margin-left:${mrg}px;" class="frame">
                                                                              <p><span class="label">Remark ::</span>${response.data[i].remark_Statuses[j].remark}</p>
                                                                                              <p><span class="label">Remark by ::</span>${response.data[i].remark_Statuses[j].remarK_ID}</p>
                                                                                      <p><span class="label">Remark date ::</span>${response.data[i].remark_Statuses[j].remarK_DT}</p>
                                                                       <a href="#" class="reply-link" onclick="showremark('${response.data[i].remark_Statuses[j].id}')">reply</a>
                                            </div>`;
                                        if (tmpchkdup != response.data[i].remark_Statuses[j].ID_REMARK_UPLINE) {
                                            mrg = mrg + 10;
                                        }
                                        tmpchkdup = response.data[i].remark_Statuses[j].ID_REMARK_UPLINE;
                                     }
                                 }
                                render += `
                                <li>
                                   <div class="frame">
                                              <p><strong class="label">change to ::</strong>${response.data[i].status_description}</p>
                                                      <p><strong class="label">change date ::</strong>${formatedate(response.data[i].fsystem_dt)}</p>
                                                      <p><strong class="label">change by ::</strong>${response.data[i].fsystem_id}</p>
                                                      <p><strong class="label">due date ::</strong>${formatedate(response.data[i].due_dt)}</p>
                                              <a href="#" class="reply-link" onclick="showremark('${response.data[i].id}')">reply</a>
                                   </div>
                                           ${rederreply}
                                </li>
                              `
                            }
                            $('#renderiframe').append(render)
                            $('#showtimeline').click()


                        } else {
                            Swal.fire({
                                icon: "waring",
                                title: "Oops...",
                                text: 'ไม่พบข้อมูล'
                            });
                        }

                    } else {
                        Swal.fire({
                            icon: "error",
                            title: "Oops...",
                            text: response.error
                        });
                    }

                },
                error: function () {

                }
            });

        }

        const updatestatus = () => {            
            $.ajax({
                url: '@Url.Action("UpdateStatus", "Home")',
                type: 'POST',
                dataType: 'json',
                data: {
                    company_id: $('#companyid').val(),
                    priority: $('#edpriority').val(),
                    status_code: $('#edstatus').val(),
                    remark: $('#remark').val(),
                    noti_dt: $('#ednoti').val(),
                   name: $('#edName').val(),
                   website: $('#edwebsite').val(),
                   contract: $('#edContact').val(),
                    position: $('#edPosition').val(),
                    persen: $('#edPersen').val(),
                   email:  $('#edEmail').val(),
                   mobile:  $('#edMobile').val(),
                   modeltype: $('#edModelTypes').val(),
                   location: $('#edLocation').val(),
                   people: $('#edPeople').val(),
                   dealvalue:$('#edDealvalue').val(),
                   Dealcreationdate:  $('#edDealcreationdate').val(),
                   Duedatefollowup: $('#edDuedatefollowup').val()
                },
                success: function (response) {

                    if (response.success) {

                        Swal.fire("Saved!", "", "success");

                        setTimeout(function () {
                            //your code to be executed after 1 second
                            $('#closemodal').click()
                            $('#frmsearch').submit()
                        }, 2000);
                    } else {
                        Swal.fire({
                            icon: "error",
                            title: "Oops...",
                            text: response.error
                        });
                    }

                },
                error: function () {

                }
            });

        }

        const getdate =(dtvalue)=>{
            let dt = new Date(dtvalue);
            let dtstr = dt.toLocaleString(dateLocation, options);
            return dtstr.replace(/(\d{2})\/(\d{2})\/(\d{4})/, dateformat);
        }
        const showremark =(id)=>{
            $('#ID_REMARK_UPLINE').val(id)
            $('#showreply').click()
        }
        const SaveRemark=()=>{
            $.ajax({
                        url: '@Url.Action("INSERT_REMARK_REPLY", "Home")',
                        type: 'POST',
                        dataType: 'json',
                        data: {
                            ID_REMARK_UPLINE: $('#ID_REMARK_UPLINE').val(),
                            REMARK: $('#remarkreply').val()
                        },
                        success: function (response) {
                            if (response.success) {
                                Swal.fire("Saved!", "", "success");
                        $('#remarkreply').val('')
                        $('#clsreply').click()
                    } else {
                                Swal.fire({
                                    icon: "error",
                                    title: "Oops...",
                                    text: response.error
                                });
                            }

                        },
                        error: function () {

                        }
                    });
        }

        const formatedate =(date)=>{
            
            // แปลงเป็นวัตถุ Date
            let dateObject = new Date(date);

            // จัดรูปแบบวันที่และเวลา
            return `${dateObject.getMonth() + 1}/${dateObject.getDate()}/${dateObject.getFullYear()} ${dateObject.toLocaleTimeString()}`;
        }
    </script>
}